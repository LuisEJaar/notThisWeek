<%- include('partials/header') -%>
<div class="container border border-3">
  <div class="mt-1">
    <a class="btn btn-primary" href="/profile">DM Profile</a>
    <a class="btn btn-primary" href="/feed">All games</a>
    <a class="btn btn-primary" href="/post/<%= encounter.post%>">Return to game</a>
      
  </div>
  <div class="row justify-content-center mt-5">
    <div class="col-6">
      <h2><%= encounter.title %></h2>
      <img class="img-fluid" src="<%= encounter.image%>" />
      <div class="row justify-content-between">
        <form
          class="col-1"
          action="/encounter/likeEncounter/<%= encounter.id %>?_method=PUT"
          method="POST"
        >
          <button class="btn btn-primary fa fa-heart" type="submit"></button>
        </form>
        <h3 class="col-3">Likes: <%= encounter.likes %></h3>
        <%if(encounter.dm == user.id){ %>
        <form
          action="/encounter/deleteEncounter/<%= encounter.id %>?_method=DELETE"
          method="POST"
          class="col-3"
        >
        <button class="btn btn-primary fa fa-trash" type="submit"></button>
        </form>
        <%}%>
      </div>
    </div>
    <div class="col-3 mt-5">
      <p><%= encounter.description %></p>
    </div>
    <div class="container">
        <h3>Players:</h3>
        <% party.forEach(member => {%>
          <a class="btn btn-primary"><%= member.userName%></a>
        <%})%>
        <h3>Player Turn:</h3>
        <% if(encounter.active) {%>
          <% if(encounter.dmTurn) {%>
            <a class="btn btn-primary"> DM </a>
          <%} else {%>
            <a class="btn btn-primary"><%= playerTurn.userName %></a>
          <%}%>
        <%} else {%>
          <span>This encounter has concluded</span>
        <%}%>
    </div>
  </div>
</div>
<div class="container mt-5">
  <div class="d-flex justify-content-center">
  <% if(playerTurn.id == user.id && encounter.active){%>
    <% if(encounter.dmTurn) {%>
      <span>You will be next, the DM is thinking.</span>
    <%} else {%>
      <span>It is your turn</span> 
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRound">
        Add round
      </button>
      <form
            class="col-1"
            action="/encounter/progressEncounter/<%= encounter.id %>?_method=PUT"
            method="POST"
          >
            <button class="btn btn-warning" type="submit">Pass</button>
      </form>
    <%}%>
  <%} else if(playerTurn.id != user.id && user.id != encounter.dm && encounter.active) {%>
    <% if(encounter.dmTurn){%>
      <span>Please be patient, the DM is thinking.</span>
    <%} else {%>
      <span>Please be patient, <%= playerTurn.userName %> is thinking. </span> 
    <%}%>
  <%} else if(user.id == encounter.dm && encounter.active) {%>
    <span>Hello God, your will be done:</span>
    <% if(encounter.dmTurn){%>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRound">
        Add round
      </button>
      <form
            class="col-1"
            action="/encounter/skipDM/<%= encounter.id %>?_method=PUT"
            method="POST"
          >
            <button class="btn btn-warning" type="submit">Pass</button>
      </form>
    <%} else {%>
      <form
          class="col-1"
          action="/encounter/progressEncounter/<%= encounter.id %>?_method=PUT"
          method="POST"
        >
          <button class="btn btn-warning" type="submit">Skip current player</button>
      </form>
    <%} %> 
    <form
        class="col-1"
        action="/encounter/toggleEncounter/<%= encounter.id %>?_method=PUT"
        method="POST"
      >
        <button class="btn btn-danger" type="submit">End Encounter</button>
    </form>
  <%} else {%>
    <span>This encounter has concluded</span>
    <form
          class="col-1"
          action="/encounter/toggleEncounter/<%= encounter.id %>?_method=PUT"
          method="POST"
        >
          <button class="btn btn-danger" type="submit">Re-Open Encounter</button>
      </form>
  <%}%>
  
  </div>
  <div class="container">

  </div>
</div>

<!-- Modal Encounter-->
<div class="modal fade" id="addRound" tabindex="-1" aria-labelledby="addRoundLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newRoundLabel">New Round</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="/round/createRound/<%= encounter.id %>/<%= user.id%>" method="POST">
          <!-- Description -->
          <div class="form-group mb-3">
            <label for="encounterDescription">Encounter Description</label>
            <textarea type="text" class="form-control" id="encounterDescription" placeholder="Encounter Description" name="description"></textarea>
          </div>
          <button type="submit" class="mx-auto btn btn-primary" value="Upload">Submit</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') -%>
